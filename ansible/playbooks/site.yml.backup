# =============================================================================
# ANSIBLE/PLAYBOOKS/SITE.YML - Playbook principal Fode-DevOps
# =============================================================================
---
- name: ğŸš€ Configuration complÃ¨te infrastructure Fode-DevOps
  hosts: fode_devops_prod
  become: yes
  gather_facts: yes
  
  vars:
    fode_devops_banner: |
      
      ======================================
      ğŸš€ FODE-DEVOPS ANSIBLE AUTOMATION ğŸš€
      ======================================
      Infrastructure: {{ project_name }}-{{ environment }}
      Date: {{ ansible_date_time.date }}
      Serveur: {{ inventory_hostname }}
      ======================================
      
  tasks:
    - name: ğŸ“¢ Affichage banniÃ¨re Fode-DevOps
      debug:
        msg: "{{ fode_devops_banner }}"
    
    - name: ğŸ“Š Collecte des informations systÃ¨me
      setup:
        gather_subset:
          - hardware
          - network
          - virtual
    
    - name: ğŸ”„ Mise Ã  jour du systÃ¨me
      dnf:
        name: "*"
        state: latest
        update_cache: yes
      register: system_update
    
    - name: ğŸ“¦ Installation des packages Fode-DevOps
      dnf:
        name: "{{ packages }}"
        state: present
    
    - name: ğŸŒ VÃ©rification du service Apache
      systemd:
        name: httpd
        state: started
        enabled: yes
    
    - name: ğŸ“ CrÃ©ation du script de monitoring Fode-DevOps
      template:
        src: monitor.sh.j2
        dest: /home/ec2-user/fode-devops-monitor-ansible.sh
        mode: '0755'
        owner: ec2-user
        group: ec2-user
    
    - name: ğŸ”§ Configuration du firewall
      firewalld:
        port: "{{ item }}/tcp"
        permanent: yes
        state: enabled
        immediate: yes
      loop:
        - "{{ web_port }}"
        - "{{ ssl_port }}"
      ignore_errors: yes
    
    - name: ğŸ“„ CrÃ©ation page de test Ansible
      template:
        src: ansible-test.html.j2
        dest: /var/www/html/ansible-test.html
        mode: '0644'
        owner: apache
        group: apache
    
    - name: ğŸ·ï¸ Ajout de tags AWS via CLI
      shell: |
        aws ec2 create-tags --region {{ aws_region }} \
        --resources {{ instance_id }} \
        --tags Key=ManagedBy,Value=Ansible Key=UpdatedBy,Value=Fode-DevOps-Ansible
      environment:
        AWS_DEFAULT_REGION: "{{ aws_region }}"
      ignore_errors: yes
    
    - name: ğŸ“Š Collecte des mÃ©triques systÃ¨me
      shell: |
        echo "=== FODE-DEVOPS SYSTEM METRICS ==="
        echo "Uptime: $(uptime)"
        echo "Memory: $(free -h | grep Mem)"
        echo "Disk: $(df -h / | tail -1)"
        echo "Load: $(cat /proc/loadavg)"
        echo "Processes: $(ps aux | wc -l)"
      register: system_metrics
    
    - name: ğŸ“ˆ Affichage des mÃ©triques
      debug:
        msg: "{{ system_metrics.stdout_lines }}"
    
    - name: âœ… Validation finale
      uri:
        url: "http://{{ ansible_host }}/ansible-test.html"
        method: GET
        status_code: 200
      delegate_to: localhost
      register: web_check
    
    - name: ğŸ‰ Message de succÃ¨s Fode-DevOps
      debug:
        msg: |
          
          âœ… Configuration Ansible terminÃ©e avec succÃ¨s !
          
          ğŸŒ Site web: http://{{ ansible_host }}
          ğŸ§ª Page test: http://{{ ansible_host }}/ansible-test.html
          ğŸ“Š Monitoring: ssh ec2-user@{{ ansible_host }} './fode-devops-monitor-ansible.sh'
          
          ğŸš€ Infrastructure Fode-DevOps opÃ©rationnelle !
